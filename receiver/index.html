<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Mic Receiver</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
      background: #f8f8f8;
    }
    .mic-indicator {
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0.5rem auto;
    }
    .bar {
      height: 10px;
      background: green;
      margin-left: 10px;
      transition: width 0.1s ease;
    }
  </style>
</head>
<body>
  <h2>ðŸŽ§ Mic Cast Receiver</h2>
  <div id="indicators"></div>
  <script>
    const sessionId = location.pathname.split('/').pop();
    const ws = new WebSocket(`wss://mic-cast-streamer.onrender.com/${sessionId}`);
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const indicators = {};

    function updateIndicator(name, volume) {
      if (!indicators[name]) {
        const el = document.createElement("div");
        el.className = "mic-indicator";
        el.innerHTML = `<span>${name}</span><div class="bar" style="width:0px;"></div>`;
        indicators[name] = el;
        document.getElementById("indicators").appendChild(el);
      }
      const width = Math.min(100, volume * 200);
      indicators[name].querySelector(".bar").style.width = `${width}px`;
    }

    ws.onmessage = async (event) => {
      const { name, data } = JSON.parse(event.data);
      const int16 = new Int16Array(data);
      const float32 = new Float32Array(int16.length);
      for (let i = 0; i < int16.length; i++) {
        float32[i] = int16[i] / 32768;
      }

      // Calculate rough volume
      const rms = Math.sqrt(float32.reduce((sum, s) => sum + s * s, 0) / float32.length);
      updateIndicator(name, rms);

      const buffer = ctx.createBuffer(1, float32.length, 44100);
      buffer.copyToChannel(float32, 0);
      const source = ctx.createBufferSource();
      source.buffer = buffer;
      source.connect(ctx.destination);
      source.start();
    };
  </script>
</body>
</html>
