<!DOCTYPE html>
<html>
<head>
  <title>Mic Receiver</title>
</head>
<body>
  <h1>Mic Receiver</h1>

  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const ws = new WebSocket("wss://mic-cast-streamer.onrender.com");
    ws.binaryType = "arraybuffer";

    audioCtx.resume().then(() => {
      console.log("AudioContext resumed");

      // Optional test tone to confirm output
      const testOsc = audioCtx.createOscillator();
      testOsc.frequency.value = 440;
      testOsc.connect(audioCtx.destination);
      testOsc.start();
      testOsc.stop(audioCtx.currentTime + 1);
      console.log("Played test tone");
    }).catch(err => {
      console.error("AudioContext resume failed:", err);
    });

    ws.onopen = () => {
      console.log("WebSocket connected");
    };

    ws.onmessage = async (event) => {
      console.log("Received chunk of size:", event.data.byteLength);
      try {
        const buffer = await audioCtx.decodeAudioData(event.data.slice(0));
        const samples = buffer.getChannelData(0);
        console.log('First 10 samples:', samples.slice(0, 10));
        console.log('Decoded audio buffer duration:', buffer.duration);

        const source = audioCtx.createBufferSource();
        source.buffer = buffer;

        const gain = audioCtx.createGain();
        gain.gain.value = 3;
        source.connect(gain);
        gain.connect(audioCtx.destination);

        source.start();
        console.log("Playback started");
      } catch (err) {
        console.error("Error decoding audio:", err);
      }
    };

    ws.onerror = (err) => {
      console.error("WebSocket error:", err);
    };

    ws.onclose = () => {
      console.warn("WebSocket closed");
    };
  </script>
</body>
</html>
