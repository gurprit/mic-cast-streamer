<!DOCTYPE html>
<html>
<head>
  <title>Mic Receiver</title>
</head>
<body>
  <h1>Mic Receiver</h1>
  <script>
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const ws = new WebSocket("wss://mic-cast-streamer.onrender.com");

    let bufferQueue = [];

    ws.binaryType = "arraybuffer";

    ws.onmessage = (event) => {
      const int16Array = new Int16Array(event.data);
      const float32 = new Float32Array(int16Array.length);
      for (let i = 0; i < int16Array.length; i++) {
        float32[i] = int16Array[i] / 0x7FFF;
      }
      bufferQueue.push(float32);
    };

    // Playback loop (approx every 100ms)
    setInterval(() => {
      if (bufferQueue.length > 0) {
        const samples = bufferQueue.shift();
        const audioBuffer = audioCtx.createBuffer(1, samples.length, audioCtx.sampleRate);
        audioBuffer.copyToChannel(samples, 0);

        const source = audioCtx.createBufferSource();
        source.buffer = audioBuffer;
        source.connect(audioCtx.destination);
        source.start();
      }
    }, 100);
  </script>
</body>
</html>
