<!DOCTYPE html>
<html>
<head>
  <title>Mic Cast Receiver</title>
</head>
<body>
  <h1>ğŸ”Š Mic Cast Receiver</h1>
  <p>Status: <span id="status">Connecting...</span></p>
  <script>
    const statusEl = document.getElementById('status');

    const sampleRate = 44100; // Match sender's audio context rate
    const socket = new WebSocket('wss://mic-cast-streamer.onrender.com');
    socket.binaryType = 'arraybuffer';

    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let started = false;

    socket.onopen = () => {
      statusEl.textContent = 'WebSocket connected âœ…';
    };

    socket.onmessage = (event) => {
      const int16Data = new Int16Array(event.data);
      const float32Data = new Float32Array(int16Data.length);

      for (let i = 0; i < int16Data.length; i++) {
        float32Data[i] = int16Data[i] / 32768;
      }

      const audioBuffer = audioCtx.createBuffer(1, float32Data.length, sampleRate);
      audioBuffer.copyToChannel(float32Data, 0);

      const source = audioCtx.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(audioCtx.destination);
      source.start();

      console.log("Received chunk of size:", event.data.byteLength);
      console.log("First 10 samples:", float32Data.slice(0, 10));
    };

    document.body.addEventListener('click', () => {
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
        statusEl.textContent = 'AudioContext resumed ğŸ§';
      }
    });

    socket.onerror = (err) => {
      console.error("WebSocket error", err);
      statusEl.textContent = 'WebSocket error âŒ';
    };

    socket.onclose = () => {
      statusEl.textContent = 'WebSocket closed ğŸ”Œ';
    };
  </script>
</body>
</html>
