<!DOCTYPE html>
<html>
<head>
  <title>Mic Cast Sender</title>
</head>
<body>
  <h1>🎤 Mic Cast Sender</h1>
  <p>Status: <span id="status">Initializing...</span></p>
  <label for="gainControl">🎛️ Gain: </label>
  <input type="range" id="gainControl" min="0" max="5" step="0.1" value="1">
  <span id="gainValue">1.0</span>x

  <script>
    const statusEl = document.getElementById('status');
    const gainSlider = document.getElementById('gainControl');
    const gainValueEl = document.getElementById('gainValue');

    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let gainNode = audioCtx.createGain();
    gainNode.gain.value = parseFloat(gainSlider.value);

    gainSlider.oninput = () => {
      gainNode.gain.value = parseFloat(gainSlider.value);
      gainValueEl.textContent = gainSlider.value;
    };

    async function startMic() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioCtx.createMediaStreamSource(stream);
        const processor = audioCtx.createScriptProcessor(2048, 1, 1);
        const socket = new WebSocket('wss://mic-cast-streamer.onrender.com');

        socket.onopen = () => statusEl.textContent = 'WebSocket connected ✅';

        source.connect(gainNode);
        gainNode.connect(processor);
        processor.connect(audioCtx.destination); // Optional: for local monitoring

        processor.onaudioprocess = e => {
          if (socket.readyState === WebSocket.OPEN) {
            const input = e.inputBuffer.getChannelData(0);
            const pcm = new Int16Array(input.length);
            for (let i = 0; i < input.length; i++) {
              pcm[i] = Math.max(-1, Math.min(1, input[i])) * 32767;
            }
            socket.send(pcm.buffer);
          }
        };

        statusEl.textContent = 'Mic started 🎙️';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Mic error ❌';
      }
    }

    document.body.addEventListener('click', () => {
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    });

    startMic();
  </script>
</body>
</html>
