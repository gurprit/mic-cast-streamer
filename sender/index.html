<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Mic Cast Sender</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin-top: 2rem; background: #f0f0f0; }
    button { font-size: 1.2rem; padding: 1rem; background-color: #007BFF; color: white; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background-color: #0056b3; }
  </style>
</head>
<body>
  <h2>ðŸŽ¤ Mic Cast Sender</h2>
  <button id="startBtn">Start Streaming</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session');
    if (!sessionId) {
      alert("Session ID is missing in the URL.");
      throw new Error("Session ID is missing.");
    }

    const startBtn = document.getElementById('startBtn');

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      startBtn.innerText = "Streaming...";

      const ws = new WebSocket("ws://localhost:8080");
      ws.binaryType = "arraybuffer";

      ws.onopen = async () => {
        ws.send(JSON.stringify({ type: 'join', sessionId }));

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);

        const processor = audioCtx.createScriptProcessor(2048, 1, 1);
        const gainNode = audioCtx.createGain();
        gainNode.gain.value = 2.0;

        source.connect(gainNode).connect(processor).connect(audioCtx.destination);

        processor.onaudioprocess = (e) => {
          const input = e.inputBuffer.getChannelData(0);
          const int16Buffer = new Int16Array(input.length);
          for (let i = 0; i < input.length; i++) {
            int16Buffer[i] = input[i] * 32767;
          }
          if (ws.readyState === WebSocket.OPEN) {
            ws.send(int16Buffer.buffer);
          }
        };
      };
    };
  </script>
</body>
</html>
