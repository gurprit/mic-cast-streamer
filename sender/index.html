<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Mic Sender</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 1rem;
      background: #f0f0f0;
    }
    input, button {
      margin: 10px;
      padding: 10px;
      font-size: 1rem;
      width: 80%;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <h2>ðŸŽ¤ Mic Sender</h2>
  <input id="nameInput" placeholder="Enter your name" />
  <button id="startBtn">Start Sending Audio</button>

  <script>
    let ws;
    let sessionId = new URLSearchParams(location.search).get("session");
    if (!sessionId) {
      alert("Session ID is missing.");
      throw new Error("Session ID is missing.");
    }

    document.getElementById("startBtn").onclick = async () => {
      const name = document.getElementById("nameInput").value || "Anonymous";
      const ws = new WebSocket(`wss://mic-cast-streamer.onrender.com/?session=${sessionId}`);
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      const ctx = new AudioContext();
      const src = ctx.createMediaStreamSource(stream);
      const processor = ctx.createScriptProcessor(2048, 1, 1);

      src.connect(processor);
      processor.connect(ctx.destination);

      processor.onaudioprocess = e => {
        const input = e.inputBuffer.getChannelData(0);
        const int16 = new Int16Array(input.length);
        for (let i = 0; i < input.length; i++) {
          int16[i] = Math.max(-1, Math.min(1, input[i])) * 32767;
        }

        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ name, data: Array.from(int16) }));
        }
      };
    };
  </script>
</body>
</html>
